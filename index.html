<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <title>Ollama Chat</title>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
      <script>hljs.highlightAll();</script>
      <!-- Marked.js -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <style>
         body {
         font-family: sans-serif;
         max-width: 800px;
         margin: auto;
         padding: 20px;
         background: #f1f1f1;
         }
         .chat-box {
         background: white;
         padding: 20px;
         border-radius: 8px;
         box-shadow: 0 0 10px #ccc;
         max-height: 600px;
         overflow-y: auto;
         margin-bottom: 20px;
         }
         .msg {
         margin-bottom: 20px;
         }
         .user strong {
         color: #1a73e8;
         }
         .assistant strong {
         color: #0b8043;
         }
         textarea, select {
         width: 100%;
         font-size: 1em;
         padding: 10px;
         margin: 10px 0;
         }
         button {
         padding: 10px 20px;
         font-size: 1em;
         }
         .message-content pre {
         background: #f6f8fa;
         padding: 10px;
         border-radius: 6px;
         overflow-x: auto;
         position: relative;
         margin-top: 1.5em;
         }
         .message-content code {
         font-family: monospace;
         }
         .download-btn {
         position: absolute;
         top: -2.2em;
         right: 0;
         font-size: 0.85em;
         background: #ddd;
         border: none;
         padding: 3px 6px;
         border-radius: 4px;
         cursor: pointer;
         z-index: 1;
         }
         #thinking {
         display: none;
         color: #999;
         font-style: italic;
         margin: 5px 0 20px 0;
         }
      </style>
   </head>
   <body>
      <h1>Ollama Chat</h1>
      <label for="model">Model name:</label>
      <select id="model"></select>
      <div class="chat-box" id="chatBox"></div>
      <textarea id="prompt" rows="3" placeholder="Type your message here..."></textarea>
      <button onclick="sendPrompt()">Send</button>
      <p id="thinking">Assistant is thinking...</p>
      <script>
         let conversation = [];
         
         function renderChat() {
           const chatBox = document.getElementById('chatBox');
           chatBox.innerHTML = '';
         
           for (const msg of conversation) {
             const div = document.createElement('div');
             div.classList.add('msg');
         
             const role = msg.role === 'user' ? 'You' : 'Assistant';
             const colorClass = msg.role === 'user' ? 'user' : 'assistant';
         
             const content = marked.parse(msg.content);
         
             div.innerHTML = `
               <div class="${colorClass}">
                 <strong>${role}:</strong>
                 <div class="message-content">${content}</div>
               </div>
             `;
             chatBox.appendChild(div);
           }
         
           hljs.highlightAll();
           addDownloadButtons();
           chatBox.scrollTop = chatBox.scrollHeight;
         }
         
         function addDownloadButtons() {
           const blocks = document.querySelectorAll('.message-content pre');
           blocks.forEach((block, i) => {
             if (block.querySelector('.download-btn')) return;
             const codeEl = block.querySelector('code');
             if (!codeEl) return;
         
             const btn = document.createElement('button');
             btn.textContent = 'ðŸ“¥ Download';
             btn.className = 'download-btn';
             btn.onclick = () => {
               const code = codeEl.innerText;
               const blob = new Blob([code], { type: 'text/plain' });
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `snippet-${i + 1}.txt`;
               a.click();
               URL.revokeObjectURL(url);
             };
         
             const wrapper = document.createElement('div');
             wrapper.style.position = 'relative';
             wrapper.appendChild(btn);
             wrapper.appendChild(block.cloneNode(true));
             block.replaceWith(wrapper);
           });
         }
         
         async function sendPrompt() {
           const model = document.getElementById('model').value.trim();
           const prompt = document.getElementById('prompt').value.trim();
           const thinking = document.getElementById('thinking');
           if (!prompt || !model) return;
           conversation.push({ role: 'user', content: prompt });
           renderChat();
           document.getElementById('prompt').value = '';
           thinking.style.display = 'block';
           let assistantMsg = { role: 'assistant', content: '' };
           conversation.push(assistantMsg);
           renderChat();
           try {
             const res = await fetch('http://localhost:11434/api/chat', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                 model,
                 messages: conversation.slice(0, -1),
                 stream: true
               })
             });
             const reader = res.body.getReader();
             const decoder = new TextDecoder();
             let buffer = '';
             while (true) {
               const { done, value } = await reader.read();
               if (done) break;
               buffer += decoder.decode(value, { stream: true });
               const lines = buffer.split('\n');
               buffer = lines.pop();
               for (let line of lines) {
                 if (!line.trim()) continue;
                 const json = JSON.parse(line);
                 if (json.done) continue;
                 if (json.message?.content) {
                   assistantMsg.content += json.message.content;
                   renderChat();
                 }
               }
             }
           } catch (err) {
             assistantMsg.content = `Error: ${err.message}`;
           }
           thinking.style.display = 'none';
           renderChat();
         }

		window.addEventListener('DOMContentLoaded', async () => {
		  const select = document.getElementById('model');
		  try {
			const res = await fetch('http://localhost:11434/v1/models');
			const data = await res.json(); // <- contains .data array
			select.innerHTML = '';
			data.data.forEach(model => {
			  const opt = document.createElement('option');
			  opt.value = model.id;
			  opt.textContent = model.id;
			  select.appendChild(opt);
			});
		  } catch (err) {
			console.error('Failed to load models:', err);
			const fallback = document.createElement('option');
			fallback.value = 'llama3.1';
			fallback.textContent = 'llama3.1 (default)';
			select.appendChild(fallback);
		  }
		});
	

      </script>
   </body>
</html>
